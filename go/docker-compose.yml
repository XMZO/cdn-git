services:
  redis:
    image: redis:7-alpine
    container_name: hazuki-go-redis
    restart: unless-stopped
    volumes:
      - hazuki-go-redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  hazuki-go:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hazuki-go
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "3100:3100" # admin panel
      - "3000:3000" # torcherino
      - "3001:3001" # cdnjs
      - "3002:3002" # git (default instance)
      # If you enable extra git instances, expose their ports too (example):
      # - "3003:3003" # git instance: gitInstances[0].port = 3003
    environment:
      - HAZUKI_DB_PATH=/data/hazuki.db
      # Override local default (go/.env.example uses 127.0.0.1)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Allow the admin panel to update the host .env when rotating HAZUKI_MASTER_KEY.
      - HAZUKI_ENV_FILE=/app/.env
    env_file:
      - .env
    volumes:
      # Bind mount for easy access to the SQLite DB (./data/hazuki.db)
      - ./data:/data
      # Optional: bind mount .env so Hazuki can update it on master key rotation.
      - ./.env:/app/.env

volumes:
  hazuki-go-redis-data:
