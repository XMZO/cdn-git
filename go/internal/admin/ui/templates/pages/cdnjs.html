{{define "cdnjs"}}
  <div class="grid">
    <div class="card">
      <h2>{{.Title}} <span class="muted small">{{.T "cdnjs.tagline"}}</span></h2>
      <div class="muted small">{{.T "cdnjs.proxyPrefix"}} <code>{{.Cdnjs.AssetURL}}</code> {{.T "cdnjs.proxySuffix"}}</div>
      <div class="btn-row">
        <span class="pill">{{.T "common.serviceUrl"}}：<code>{{.CdnjsBaseURL}}</code></span>
        {{if .CdnjsStatus.Status}}{{template "serviceStatusPill" (statusCtx $ .CdnjsStatus)}}{{end}}
        <a class="btn" href="{{.CdnjsHealthURL}}" target="_blank" rel="noreferrer">{{.T "common.openHealth"}}</a>
      </div>
      {{if and (eq .CdnjsStatus.Status "error") .CdnjsStatus.Error}}
        <div class="muted small" style="margin-top:10px;">{{.T "common.healthErrorPrefix"}}：{{.CdnjsStatus.Error}}</div>
      {{end}}
      <div class="muted small" style="margin-top:10px;">
        {{.T "cdnjs.usage"}}：<code>{{.CdnjsBaseURL}}/gh/&lt;user&gt;/&lt;repo@ref/path&gt;</code> {{.T "common.or"}} <code>{{.CdnjsBaseURL}}/&lt;repo@ref/path&gt;</code>（{{.T "cdnjs.usageDefaultUser" }}）
      </div>
    </div>

    <form class="form" method="post" action="/config/cdnjs">
      <div class="card">
        <h3>{{.T "common.basicConfig"}}</h3>
        <div class="grid cols-2">
          <div class="field">
            <label>{{.T "common.port"}} <span class="key">ports.cdnjs</span></label>
            <input type="text" name="cdnjsPort" value="{{.CdnjsPortValue}}" placeholder="3001" />
            <div class="hint">{{.T "common.modifiedPortRestart"}}</div>
          </div>
          <div class="field">
            <label>{{.T "cdnjs.assetUrlLabel"}} <span class="key">ASSET_URL</span></label>
            <input type="text" name="assetUrl" value="{{.Cdnjs.AssetURL}}" placeholder="https://cdn.jsdelivr.net" required />
            <div class="hint">{{.T "common.usuallyNoNeedChange"}}</div>
          </div>
        </div>
        <div class="field">
          <label style="display:flex; gap:10px; align-items:center; font-weight:900;">
            <input type="checkbox" name="serviceEnabled" {{if not .Cdnjs.Disabled}}checked{{end}} />
            <input type="hidden" name="serviceEnabled" value="0" />
            {{.T "common.enableService"}} <span class="key">cdnjs.disabled</span>
          </label>
          <div class="hint">{{.T "cdnjs.serviceToggleHint"}}</div>
        </div>
      </div>

      <details class="card accordion" open>
        <summary>{{.T "common.accessRules"}} <span class="muted small">{{.T "common.githubUsersTag"}}</span></summary>
        <div class="body">
          <div class="field">
            <label>{{.T "cdnjs.ghUserPolicyLabel"}} <span class="key">GH_USER_POLICY</span></label>
            <select name="ghUserPolicy">
              <option value="allowlist" {{if eq .GhUserPolicyValue "allowlist"}}selected{{end}}>{{.T "cdnjs.policy.allowlist"}}</option>
              <option value="denylist" {{if eq .GhUserPolicyValue "denylist"}}selected{{end}}>{{.T "cdnjs.policy.denylist"}}</option>
            </select>
            <div class="hint">
              <code>allowlist</code>{{.T "cdnjs.ghUserPolicyHintAllowlist"}} <code>ALLOWED_GH_USERS</code>{{.T "common.semicolon"}}<code>denylist</code>{{.T "cdnjs.ghUserPolicyHintDenylist"}} <code>BLOCKED_GH_USERS</code>{{.T "common.period"}}
            </div>
          </div>

          <div class="field">
            <label>{{.T "cdnjs.defaultUserLabel"}} <span class="key">DEFAULT_GH_USER</span></label>
            <input type="text" name="defaultGhUser" value="{{.Cdnjs.DefaultGhUser}}" placeholder="XMZO" />
            <div class="hint">{{.T "cdnjs.defaultUserHintPrefix"}} <code>/repo@ref/path</code> {{.T "cdnjs.defaultUserHintMiddle"}} <code>/gh/DEFAULT_GH_USER/repo@ref/path</code>{{.T "common.period"}}</div>
          </div>
          <div class="field">
            <label>{{.T "cdnjs.allowedUsersLabel"}} <span class="key">ALLOWED_GH_USERS</span></label>
            <input type="text" name="allowedGhUsers" value="{{.AllowedUsersCsv}}" placeholder="XMZO,starsei" />
            <div class="hint">{{.T "cdnjs.allowedUsersHintPrefix"}} <code>/gh/&lt;user&gt;/...</code> {{.T "common.commaSeparatedCaseInsensitive"}} {{.T "common.semicolon"}}{{.T "cdnjs.allowedUsersHintSuffix"}} <code>/gh/*</code>{{.T "common.period"}}</div>
          </div>
          <div class="field">
            <label>{{.T "cdnjs.blockedUsersLabel"}} <span class="key">BLOCKED_GH_USERS</span></label>
            <input type="text" name="blockedGhUsers" value="{{.BlockedUsersCsv}}" placeholder="baduser1,baduser2" />
            <div class="hint">{{.T "cdnjs.blockedUsersHintPrefix"}} <code>/gh/*</code>{{.T "cdnjs.blockedUsersHintSuffix"}}{{.T "common.period"}}</div>
          </div>
        </div>
      </details>

      <details class="card accordion" open>
        <summary>{{.T "cdnjs.redisTitle"}}</summary>
        <div class="body">
          {{if .RedisStatus.Status}}
            {{if eq .RedisStatus.Status "ok"}}
              <div class="pill ok">{{.T "redis.ok"}} · {{.RedisStatus.LatencyMS}}ms · <code>{{.RedisStatus.Addr}}</code></div>
              {{if or .RedisStatus.ServerVersion .RedisStatus.UsedMemoryHuman (gt .RedisStatus.DBSize 0)}}
                <div class="muted small" style="margin-top:8px;">
                  {{if .RedisStatus.ServerVersion}}v{{.RedisStatus.ServerVersion}}{{end}}
                  {{if gt .RedisStatus.DBSize 0}} · <code>{{.RedisStatus.DBSize}}</code> keys{{end}}
                  {{if .RedisStatus.UsedMemoryHuman}} · {{.RedisStatus.UsedMemoryHuman}}{{end}}
                  {{if gt .RedisStatus.ConnectedClients 0}} · clients <code>{{.RedisStatus.ConnectedClients}}</code>{{end}}
                </div>
              {{end}}
            {{else if eq .RedisStatus.Status "error"}}
              <div class="pill err">{{.T "redis.error"}} · <code>{{.RedisStatus.Addr}}</code></div>
              {{if .RedisStatus.Error}}<div class="muted small" style="margin-top:8px;">{{.T "common.errorPrefix"}}：{{.RedisStatus.Error}}</div>{{end}}
            {{else}}
              <div class="pill">{{.T "redis.notConfigured"}}</div>
            {{end}}
          {{end}}

          <div class="grid cols-2">
            <div class="field">
              <label>Host <span class="key">REDIS_HOST</span></label>
              <input type="text" name="redisHost" value="{{.Cdnjs.Redis.Host}}" placeholder="redis" />
              <div class="hint">{{.T "cdnjs.redisHostHintPrefix"}} <code>redis</code>{{.T "common.semicolon"}}{{.T "cdnjs.redisHostHintSuffix"}} <code>127.0.0.1</code>{{.T "common.period"}}</div>
            </div>
            <div class="field">
              <label>Port <span class="key">REDIS_PORT</span></label>
              <input type="text" name="redisPort" value="{{.RedisPortValue}}" placeholder="6379" />
            </div>
          </div>
          <div class="muted small">{{.T "cdnjs.redisKeyHintPrefix"}} <code>:type</code> {{.T "cdnjs.redisKeyHintSuffix"}}</div>
        </div>
      </details>

      <details class="card accordion" open>
        <summary>{{.T "cdnjs.ttlTitle"}}</summary>
        <div class="body">
          <div class="muted small">{{.T "cdnjs.ttlDefaultRulesHint"}}</div>

          <div class="field" style="margin-top:10px;">
            <label>{{.T "cdnjs.defaultTTLLabel"}} <span class="key">defaultTTLSeconds</span></label>
            <input type="text" name="defaultTTLSeconds" value="{{.DefaultTTLValue}}" placeholder="86400" />
            <div class="hint">{{.T "cdnjs.defaultTTLHint"}}</div>
          </div>

          <div class="field">
            <label>{{.T "common.preview"}} {{.T "common.previewNoRequest"}}</label>
            <div class="hint">{{.T "cdnjs.previewHint"}}</div>
            <div class="grid cols-2">
              <input type="text" id="cdnjsPreviewPath" value="pic@main/README.md" placeholder="repo@ref/path/file.ext" />
              <input type="text" id="cdnjsPreviewUrl" value="" class="readonly" readonly />
            </div>
            <div class="hint" id="cdnjsPreviewHint"></div>
          </div>

          <div class="field">
            <label>{{.T "cdnjs.ttlOverridesLabel"}} <span class="key">ext=seconds（一行一个）</span></label>
            <textarea name="ttlOverrides" placeholder="mjs=2592000&#10;wasm=2592000&#10;webm=604800">{{.TTLOverridesValue}}</textarea>
            <div class="hint">{{.T "cdnjs.ttlOverridesHintPrefix"}} <code>#</code> {{.T "cdnjs.ttlOverridesHintSuffix"}} <code>{"mjs":2592000}</code>{{.T "common.period"}}</div>
          </div>
        </div>
      </details>

      <div class="card">
        <h3>{{.T "common.save"}}</h3>
        <div class="field">
          <label>{{.T "common.noteOptional"}}</label>
          <input type="text" name="note" value="" placeholder="{{.T "cdnjs.notePlaceholder"}}" />
        </div>
        <div class="btn-row">
          <button class="btn primary" type="submit">{{.T "common.save"}}</button>
        </div>
      </div>
    </form>
  </div>
{{end}}
