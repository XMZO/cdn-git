{{define "git"}}
  <div class="grid">
    <div class="card">
      <h2>{{.Title}}</h2>
      <div class="muted small">{{.T "git.subtitle"}}</div>
      <div class="btn-row">
        <span class="pill">{{.T "git.currentInstance"}}：<code>{{if .CurrentInstanceID}}{{.CurrentInstanceID}}{{else}}default{{end}}</code> · {{.CurrentInstanceName}}</span>
        <span class="pill">{{.T "common.serviceUrl"}}：<code>{{.GitBaseURL}}</code></span>
        {{if .GitStatus.Status}}{{template "serviceStatusPill" (statusCtx $ .GitStatus)}}{{end}}
        <a class="btn" href="{{.GitHealthURL}}" target="_blank" rel="noreferrer">{{.T "common.openHealth"}}</a>
      </div>
      {{if and (eq .GitStatus.Status "error") .GitStatus.Error}}
        <div class="muted small" style="margin-top:10px;">{{.T "common.healthErrorPrefix"}}：{{.GitStatus.Error}}</div>
      {{end}}
    </div>

    <div class="card">
      <h3>{{.T "git.instancesTitle"}}</h3>
      <div class="muted small">{{.T "git.instancesHint"}}</div>

      <div class="table-wrap" style="margin-top:12px;">
        <table class="table">
          <thead>
            <tr>
              <th>{{.T "common.name"}}</th>
              <th>{{.T "common.id"}}</th>
              <th>{{.T "common.port"}}</th>
              <th>{{.T "common.status"}}</th>
              <th>{{.T "common.actions"}}</th>
            </tr>
          </thead>
          <tbody>
            {{range .Instances}}
              <tr>
                <td>{{.Name}}</td>
                <td><code>{{.ID}}</code></td>
                <td><code>{{.Port}}</code></td>
                <td>{{template "serviceStatusPill" (statusCtx $ .Status)}}</td>
                <td>
                  <div class="btn-row" style="margin-top:0;">
                    <a class="btn" href="{{if eq .ID "default"}}/config/git{{else}}/config/git?instance={{.ID}}{{end}}">{{$.T "common.edit"}}</a>
                    <a class="btn" href="{{.BaseURL}}" target="_blank" rel="noreferrer">{{$.T "common.open"}}</a>
                    <a class="btn" href="{{.HealthURL}}" target="_blank" rel="noreferrer">{{$.T "common.health"}}</a>
                    {{if ne .ID "default"}}
                      <form method="post" action="/config/git" style="margin:0; display:inline;" onsubmit="return confirm({{printf "%q" ($.T "git.confirmDeleteInstance" .ID)}})">
                        <input type="hidden" name="action" value="deleteInstance" />
                        <input type="hidden" name="instanceID" value="{{.ID}}" />
                        <button class="btn danger" type="submit">{{$.T "common.delete"}}</button>
                      </form>
                    {{end}}
                  </div>
                </td>
              </tr>
            {{end}}
          </tbody>
        </table>
      </div>

      <details class="accordion" style="margin-top:12px;">
        <summary>{{.T "git.addInstanceTitle"}}</summary>
        <div class="body">
          <form class="form" method="post" action="/config/git">
            <input type="hidden" name="action" value="addInstance" />
            <div class="grid cols-2">
              <div class="field">
                <label>{{.T "git.instanceIDLabel"}}</label>
                <input type="text" name="newInstanceID" value="" placeholder="{{.T "git.instanceIDPlaceholder"}}" required />
                <div class="hint">{{.T "git.instanceIDHintPrefix"}} <code>default</code>{{.T "common.period"}}</div>
              </div>
              <div class="field">
                <label>{{.T "git.instanceNameLabel"}} {{.T "common.optionalTag"}}</label>
                <input type="text" name="newInstanceName" value="" placeholder="{{.T "git.instanceNamePlaceholder"}}" />
              </div>
            </div>
            <div class="grid cols-2">
              <div class="field">
                <label>{{.T "common.port"}}</label>
                <input type="text" name="newInstancePort" value="" placeholder="3003" required />
                <div class="hint">{{.T "git.composeHint"}}</div>
              </div>
              <div class="field">
                <label style="display:flex; gap:10px; align-items:center; font-weight:900;">
                  <input type="checkbox" name="newInstanceEnabled" checked />
                  <input type="hidden" name="newInstanceEnabled" value="0" />
                  {{.T "git.enableAfterCreate"}}
                </label>
                <div class="hint">{{.T "git.copyDefaultHint"}}</div>
              </div>
            </div>
            <div class="btn-row">
              <button class="btn primary" type="submit">{{.T "common.add"}}</button>
            </div>
          </form>
        </div>
      </details>
    </div>

    <form class="form" method="post" action="/config/git">
      <input type="hidden" name="instanceID" value="{{.CurrentInstanceID}}" />
      <div class="card">
        <h3>{{.T "common.basicConfig"}}</h3>

        <div class="grid cols-2">
          <div class="field">
            <label>{{.T "common.port"}} <span class="key">{{.GitPortKey}}</span></label>
            <input type="text" name="gitPort" value="{{.GitPortValue}}" placeholder="3002" />
            <div class="hint">{{.T "git.portHint"}}</div>
          </div>
          <div class="field">
            <label>{{.T "git.upstreamProtocolLabel"}} <span class="key">UPSTREAM_HTTPS</span></label>
            <label class="hint" style="display:flex; gap:10px; align-items:center; font-weight:800;">
              <input type="checkbox" name="upstreamHttps" {{if .Git.HTTPS}}checked{{end}} />
              {{.T "git.useHttps"}}
            </label>
          </div>
        </div>

        <div class="field">
          <label style="display:flex; gap:10px; align-items:center; font-weight:900;">
            <input type="checkbox" name="serviceEnabled" {{if .GitEnabled}}checked{{end}} />
            <input type="hidden" name="serviceEnabled" value="0" />
            {{.T "common.enableService"}} <span class="key">git.disabled</span>
          </label>
          <div class="hint">{{.T "git.serviceToggleHint"}}</div>
        </div>

        <div class="field">
          <label>{{.T "git.upstreamPathLabel"}} <span class="key">UPSTREAM_PATH</span></label>
          <input type="text" name="upstreamPath" value="{{.Git.UpstreamPath}}" placeholder="{{.T "git.upstreamPathPlaceholder"}}" required />
          <div class="hint">{{.T "git.upstreamPathHintPrefix"}} <code>/x.png</code> {{.T "git.upstreamPathHintMiddle"}} <code>UPSTREAM_PATH + /x.png</code>{{.T "common.semicolon"}}{{.T "git.upstreamPathHintSuffix"}} <code>/</code> {{.T "git.upstreamPathHintSuffix2"}}{{.T "common.period"}}</div>
        </div>

        <div class="grid cols-2">
          <div class="field">
            <label>{{.T "git.upstreamDesktopLabel"}} <span class="key">UPSTREAM</span></label>
            <input type="text" name="upstream" value="{{.Git.Upstream}}" placeholder="raw.githubusercontent.com" />
          </div>
          <div class="field">
            <label>{{.T "git.upstreamMobileLabel"}} <span class="key">UPSTREAM_MOBILE</span></label>
            <input type="text" name="upstreamMobile" value="{{.Git.UpstreamMobile}}" placeholder="{{.Git.Upstream}}" />
            <div class="hint">{{.T "git.upstreamMobileHint"}}</div>
          </div>
        </div>

        <div class="field">
          <label>{{.T "git.previewTitle"}} {{.T "common.previewNoRequest"}}</label>
          <div class="hint">{{.T "git.previewHint"}}</div>
          <div class="grid cols-2">
            <input type="text" id="gitPreviewPath" value="/a.png" placeholder="/path/file.ext" />
            <input type="text" id="gitPreviewUrl" value="" class="readonly" readonly />
          </div>
          <div class="hint" id="gitPreviewHint"></div>
        </div>
      </div>

      <details class="card accordion" open>
        <summary>{{.T "git.authTitle"}} <span class="muted small">{{.T "git.githubTokenTag"}}</span></summary>
        <div class="body">
          <div class="field">
            <label>GitHub Token <span class="key">GITHUB_TOKEN</span></label>
            <input id="gitTokenInput" type="password" name="githubToken" value="" placeholder="{{if .TokenIsSet}}{{.T "secret.placeholderSetKeep"}}{{else}}{{.T "secret.placeholderNotSet"}}{{end}}" />
            <div class="hint hint-line">
              <span>{{.T "git.tokenHint"}}</span>
              <span class="spacer"></span>
              <label class="pill" style="font-weight:800;">
                <input type="checkbox" data-toggle-password="#gitTokenInput" />
                {{.T "common.show"}}
              </label>
              <label style="display:inline-flex; gap:8px; align-items:center; font-weight:800;">
                <input type="checkbox" name="clearGithubToken" />
                {{.T "common.clear"}}
              </label>
            </div>
          </div>

          <div class="field">
            <label>{{.T "git.authSchemeLabel"}} <span class="key">GITHUB_AUTH_SCHEME</span></label>
            <select name="githubAuthScheme">
              <option value="token" {{if eq .AuthScheme "token"}}selected{{end}}>{{.T "git.authSchemeToken"}}</option>
              <option value="Bearer" {{if eq .AuthScheme "Bearer"}}selected{{end}}>{{.T "git.authSchemeBearer"}}</option>
            </select>
            <div class="hint">{{.T "git.authSchemeHintPrefix"}} <code>token</code>{{.T "common.semicolon"}}{{.T "git.authSchemeHintSuffix"}} <code>Bearer</code>{{.T "common.period"}}</div>
          </div>
        </div>
      </details>

      <details class="card accordion" open>
        <summary>{{.T "git.cachePolicyTitle"}} <span class="muted small">（Cache-Control）</span></summary>
        <div class="body">
          <div class="field">
            <label style="display:flex; gap:10px; align-items:center; font-weight:900;">
              <input type="checkbox" name="disableCache" {{if .Git.DisableCache}}checked{{end}} />
              {{.T "git.disableCacheLabel"}} <span class="key">DISABLE_CACHE</span>
            </label>
            <div class="hint">{{.T "git.disableCacheHintPrefix"}} <code>Cache-Control: no-store</code>{{.T "git.disableCacheHintSuffix"}}</div>
          </div>

          <div class="field">
            <label>{{.T "git.cacheControlGlobalLabel"}} <span class="key">CACHE_CONTROL</span></label>
            <input type="text" name="cacheControl" value="{{.Git.CacheControl}}" placeholder="{{.T "git.cacheControlGlobalPlaceholder"}}" />
            <div class="hint">{{.T "git.cacheControlGlobalHint"}}</div>
          </div>

          <div class="grid cols-2">
            <div class="field">
              <label>{{.T "git.cacheControlMediaLabel"}} <span class="key">CACHE_CONTROL_MEDIA</span></label>
              <input type="text" name="cacheControlMedia" value="{{.Git.CacheControlMedia}}" placeholder="public, max-age=43200000" />
              <div class="hint">{{.T "git.cacheControlMediaHint"}}</div>
            </div>
            <div class="field">
              <label>{{.T "git.cacheControlTextLabel"}} <span class="key">CACHE_CONTROL_TEXT</span></label>
              <input type="text" name="cacheControlText" value="{{.Git.CacheControlText}}" placeholder="public, max-age=60" />
              <div class="hint">{{.T "git.cacheControlTextHint"}}</div>
            </div>
          </div>

          <div class="muted small">{{.T "git.cacheControlLogicPrefix"}} <code>application/octet-stream</code> {{.T "git.cacheControlLogicSuffix"}}</div>
        </div>
      </details>

      <details class="card accordion">
        <summary>CORS</summary>
        <div class="body">
          <div class="field">
            <label>{{.T "git.corsOriginLabel"}} <span class="key">CORS_ORIGIN</span></label>
            <input type="text" name="corsOrigin" value="{{.Git.CorsOrigin}}" placeholder="{{.T "git.corsOriginPlaceholder"}}" />
            <div class="hint">{{.T "git.corsOriginHintPrefix"}} <code>*</code>{{.T "common.period"}}</div>
          </div>
          <div class="field">
            <label style="display:flex; gap:10px; align-items:center; font-weight:900;">
              <input type="checkbox" name="corsAllowCredentials" {{if .Git.CorsAllowCredentials}}checked{{end}} />
              {{.T "git.corsAllowCredentialsLabel"}} <span class="key">CORS_ALLOW_CREDENTIALS</span>
            </label>
            <div class="hint">{{.T "git.corsAllowCredentialsHintPrefix"}} <code>*</code>{{.T "git.corsAllowCredentialsHintSuffix"}}</div>
          </div>
          <div class="field">
            <label>{{.T "git.corsExposeHeadersLabel"}} <span class="key">CORS_EXPOSE_HEADERS</span></label>
            <input type="text" name="corsExposeHeaders" value="{{.Git.CorsExposeHeaders}}" placeholder="Accept-Ranges, Content-Length, ..." />
            <div class="hint">{{.T "git.corsExposeHeadersHint"}}</div>
          </div>
        </div>
      </details>

      <details class="card accordion">
        <summary>{{.T "git.accessControlTitle"}}</summary>
        <div class="body">
          <div class="grid cols-2">
            <div class="field">
              <label>{{.T "git.blockedRegionsLabel"}} <span class="key">BLOCKED_REGION</span></label>
              <input type="text" name="blockedRegions" value="{{.BlockedRegionsCsv}}" placeholder="CN,HK" />
              <div class="hint">{{.T "git.blockedRegionsHintPrefix"}} <code>CF-IPCountry</code>{{.T "common.semicolon"}}{{.T "git.blockedRegionsHintSuffix"}}{{.T "common.period"}}</div>
            </div>
            <div class="field">
              <label>{{.T "git.blockedIPsLabel"}} <span class="key">BLOCKED_IP_ADDRESS</span></label>
              <input type="text" name="blockedIpAddresses" value="{{.BlockedIPsCsv}}" placeholder="0.0.0.0,127.0.0.1" />
              <div class="hint">{{.T "git.blockedIPsHint"}}</div>
            </div>
          </div>
        </div>
      </details>

      <details class="card accordion">
        <summary>{{.T "git.replaceTitle"}}</summary>
        <div class="body">
          <div class="field">
            <label>REPLACE_DICT JSON <span class="key">REPLACE_DICT</span></label>
            <textarea id="gitReplaceDictJson" name="replaceDictJson" data-json>{{.ReplaceDictJson}}</textarea>
            <div class="hint hint-line">
              <span>{{.T "git.replacePlaceholderPrefix"}} <code>$upstream</code> / <code>$custom_domain</code>{{.T "common.period"}}</span>
              <span class="spacer"></span>
              <button class="btn" type="button" data-format-json="#gitReplaceDictJson">{{.T "common.formatJson"}}</button>
              <span class="json-msg" aria-live="polite"></span>
            </div>
            <div class="hint">{{.T "git.replaceHint"}}</div>
          </div>
        </div>
      </details>

      <div class="card">
        <h3>{{.T "common.save"}}</h3>
        <div class="field">
          <label>{{.T "common.noteOptional"}}</label>
          <input type="text" name="note" value="" placeholder="{{.T "git.notePlaceholder"}}" />
        </div>
        <div class="btn-row">
          <button class="btn primary" type="submit">{{.T "common.save"}}</button>
        </div>
      </div>
    </form>
  </div>
{{end}}
